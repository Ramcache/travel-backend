version: '3'

vars:
  BIN: bin/travel-api

tasks:
  # ==== Local Dev ====
  run:
    desc: Run API server locally
    cmds:
      - go run ./cmd/api serve

  migrate:up:
    desc: Apply migrations
    cmds:
      - go run ./cmd/api migrate up

  migrate:down:
    desc: Rollback last migration
    cmds:
      - go run ./cmd/api migrate down

  # ==== CI/CD Tasks ====
  lint:
    desc: Run go vet and staticcheck
    cmds:
      - go vet ./...
      - |
        if command -v staticcheck > /dev/null; then
          staticcheck ./...
        else
          echo "⚠️ staticcheck not installed, skipping"
        fi

  test:
    desc: Run all tests locally with race detector
    cmds:
      - CGO_ENABLED=1 go test ./... -v -race -cover

  test:ci:
    desc: Run all tests in CI (faster, no race)
    cmds:
      - go test ./... -v -cover

  build:
    desc: Build binary for Linux amd64 (prod)
    cmds:
      - GOOS=linux GOARCH=amd64 go build -o {{.BIN}} ./cmd/api

  ci:
    desc: Run full CI pipeline (lint, test:ci, build)
    deps: [lint, test:ci, build]
